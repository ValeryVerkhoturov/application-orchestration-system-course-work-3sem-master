# Пример приложения с интеграцией Vault
# Демонстрирует получение секретов из Vault
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-app
  namespace: node1-services
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vault-integrated-app
  namespace: node1-services
  labels:
    app: vault-app
    node: node1
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: vault-app
  template:
    metadata:
      labels:
        app: vault-app
        node: node1
      annotations:
        # Vault Agent Injector аннотации
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "node1-app"
        # Инъекция секретов PostgreSQL
        vault.hashicorp.com/agent-inject-secret-database-config.txt: "secret/data/node1/postgres"
        vault.hashicorp.com/agent-inject-template-database-config.txt: |
          {{- with secret "secret/data/node1/postgres" -}}
          DB_HOST={{ .Data.data.host }}
          DB_PORT={{ .Data.data.port }}
          DB_NAME={{ .Data.data.database }}
          DB_USER={{ .Data.data.username }}
          DB_PASSWORD={{ .Data.data.password }}
          {{- end }}
    spec:
      serviceAccountName: vault-app
      nodeSelector:
        worker-id: node1
      restartPolicy: Always
      containers:
        - name: app
          image: alpine:latest
          command: ["sh", "-c"]
          args:
            - |
              echo "Waiting for Vault secrets..."
              while [ ! -f /vault/secrets/database-config.txt ]; do
                sleep 1
              done
              echo "Secrets received from Vault:"
              cat /vault/secrets/database-config.txt
              echo ""
              echo "Application running with Vault secrets..."
              # Загрузка переменных окружения из файла секретов
              export $(cat /vault/secrets/database-config.txt | xargs)
              echo "Connected to database: $DB_HOST:$DB_PORT/$DB_NAME as $DB_USER"
              # Бесконечный цикл для поддержания работы контейнера
              while true; do
                echo "$(date): Application heartbeat - secrets from Vault active"
                sleep 60
              done
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          livenessProbe:
            exec:
              command:
                - cat
                - /vault/secrets/database-config.txt
            initialDelaySeconds: 30
            periodSeconds: 30
            failureThreshold: 3
---
# То же для Node 2
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-app
  namespace: node2-services
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vault-integrated-app
  namespace: node2-services
  labels:
    app: vault-app
    node: node2
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: vault-app
  template:
    metadata:
      labels:
        app: vault-app
        node: node2
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "node2-app"
        vault.hashicorp.com/agent-inject-secret-database-config.txt: "secret/data/node2/postgres"
        vault.hashicorp.com/agent-inject-template-database-config.txt: |
          {{- with secret "secret/data/node2/postgres" -}}
          DB_HOST={{ .Data.data.host }}
          DB_PORT={{ .Data.data.port }}
          DB_NAME={{ .Data.data.database }}
          DB_USER={{ .Data.data.username }}
          DB_PASSWORD={{ .Data.data.password }}
          {{- end }}
    spec:
      serviceAccountName: vault-app
      nodeSelector:
        worker-id: node2
      restartPolicy: Always
      containers:
        - name: app
          image: alpine:latest
          command: ["sh", "-c"]
          args:
            - |
              echo "Waiting for Vault secrets..."
              while [ ! -f /vault/secrets/database-config.txt ]; do
                sleep 1
              done
              echo "Secrets received from Vault:"
              cat /vault/secrets/database-config.txt
              echo ""
              echo "Application running with Vault secrets..."
              export $(cat /vault/secrets/database-config.txt | xargs)
              echo "Connected to database: $DB_HOST:$DB_PORT/$DB_NAME as $DB_USER"
              while true; do
                echo "$(date): Application heartbeat - secrets from Vault active"
                sleep 60
              done
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          livenessProbe:
            exec:
              command:
                - cat
                - /vault/secrets/database-config.txt
            initialDelaySeconds: 30
            periodSeconds: 30
            failureThreshold: 3
